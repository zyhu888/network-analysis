---
title: "Assortativity(CI) & Efficiency"
author: "Zeyu Hu"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(igraph)
library(wdnet)
# source function in "utility.R" to calculate assortativity
source("/Users/huzeyu/Desktop/network analysis/repo/network-analysis/code/utility.R")
```

## read and convert data 
```{r include=FALSE}
# Read data
edges <- read.csv("/Users/huzeyu/Desktop/network analysis/repo/network-analysis/data/Edges_Weighted.csv")

# Create graph object
g <- graph_from_data_frame(d = edges, directed = FALSE)

# Add weights to graph edges
E(g)$weight <- edges$Weight

# Convert the graph to a weighted adjacency matrix
adj_matrix <- as_adjacency_matrix(g, attr = "weight", sparse = FALSE)

# Create data array for analysis
hospital_data <- array(adj_matrix, dim = c(nrow(adj_matrix), ncol(adj_matrix), 1))
```

## calculate assortativity
```{r echo=FALSE}
original_assortativity <- gen_assort(data = hospital_data)
cat("The original assortativity coefficient is:", original_assortativity, "\n")
```

## calculate CI for assortativity by jackknife
```{r echo=FALSE}
# Jackknife resampling
jackknife_assortativities <- numeric(length = vcount(g))

for (i in 1:vcount(g)) {
  # Create a new graph by removing the i-th node
  g_jackknife <- delete_vertices(g, V(g)[i])
  
  # Convert the new graph to a weighted adjacency matrix
  adj_matrix_jackknife <- get.adjacency(g_jackknife, attr = "weight", sparse = FALSE)
  
  # Create data array for the jackknife sample
  hospital_data_jackknife <- array(adj_matrix_jackknife, 
                                   dim = c(nrow(adj_matrix_jackknife), 
                                           ncol(adj_matrix_jackknife), 1))
  
  # Calculate the assortativity for the jackknife sample
  jackknife_assortativities[i] <- gen_assort(data = hospital_data_jackknife)
}

# Save assortativities for each time in a vector
assortativities_saved_each_delete <- jackknife_assortativities

# Calculate the Jackknife estimate of the mean assortativity
jackknife_mean <- mean(jackknife_assortativities)

# Calculate the Jackknife standard error
jackknife_se <- sqrt(((vcount(g) - 1) / vcount(g)) * 
                       sum((jackknife_assortativities - jackknife_mean)^2))

# Calculate the 95% confidence interval
ci_lower <- jackknife_mean - 1.96 * jackknife_se
ci_upper <- jackknife_mean + 1.96 * jackknife_se

# Print results
cat("Jackknife Mean:", jackknife_mean, "\n")
cat("Jackknife Standard Error:", jackknife_se, "\n")
cat("95% Confidence Interval: [", ci_lower, ", ", ci_upper, "]\n")
```

This code takes about 40 minutes to run, so I show the result below:
Original Assortativity: 0.4221628 
Jackknife Mean: 0.4221878 
Jackknife Standard Error: 0.05636901 
95% Confidence Interval: [ 0.3117045 ,  0.532671 ]

## Read the nodes data select the top 5 institutions and specialties
```{r echo=FALSE}
nodes <- read.csv("/Users/huzeyu/Desktop/network analysis/raw data/Nodes.csv")
nodes$Specialty <- trimws(nodes$Specialty)
# Calculate the top 5 most frequent institutions
top_institutions <- nodes %>%
  count(Institution, sort = TRUE) %>%
  top_n(5, n)

# Calculate the top 5 most frequent specialties
top_specialties <- nodes %>%
  count(Specialty, sort = TRUE) %>%
  top_n(5, n)

# Print results
cat("Top 5 Institutions:\n", paste(top_institutions$Institution, top_institutions$n, sep = ":", collapse = "\n"), "\n")
cat("Top 5 Specialties:\n", paste(top_specialties$Specialty, top_specialties$n, sep = ": ", collapse = "\n"), "\n")
```

## Calculate the assortativity for interested institution subsets
```{r echo=FALSE}
# Define the institutions of interest
institutions_of_interest <- c(
  "Icahn School of Medicine at Mount Sinai/New York Eye and Ear Infirmary at Mount Sinai",
  "Vanderbilt University Medical Center",
  "Montefiore Medical Center/Albert Einstein College of Medicine",
  "University of Michigan Health System",
  "University of Southern California/LAC+USC Medical Center"
)

# Calculate assortativity for each institution of interest
for (institution in institutions_of_interest) {
  calculate_assortativity_for_institution(institution)
}
```

## Calculate the assortativity for interested specialty subsets
```{r echo=FALSE}
# Define the specialties of interest
specialties_of_interest <- c("Head & Neck", "Pediatric", "General", "Neurotology", "Facial Plastics")

# Calculate assortativity for each specialty of interest
for (specialty in specialties_of_interest) {
  calculate_assortativity_for_specialty(specialty)
}
```

## calculate global efficiency
```{r echo=FALSE}
global_eff <- global_efficiency(g)
cat("Global Efficiency:", global_eff, "\n")
```

## Calculate the assortativity for interested institution subsets
```{r echo=FALSE}
for (institution in institutions_of_interest) {
  calculate_efficiency_for_institution(institution)
}
```

## Calculate the assortativity for interested specialty subsets
```{r echo=FALSE}
for (specialty in specialties_of_interest) {
  calculate_efficiency_for_specialty(specialty)
}
```